<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Bloxluck | Live Match & Dice</title>
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.2.min.js"></script>
<style>
:root{--bg:#0d0f13;--panel:#15181f;--card:#1c2028;--border:#262a33;--green:#2ecc71;--red:#e74c3c;--gray:#8a9199;--gold:#f1c40f}
*{box-sizing:border-box; margin:0; padding:0;}
body{background:var(--bg);color:#fff;font-family:'Segoe UI',sans-serif;display:flex;height:100vh;overflow:hidden}
.main{flex:1;display:flex;flex-direction:column;position:relative;overflow:hidden}
.chat-area{width:300px;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column}
.header{height:65px;background:var(--panel);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 30px;justify-content:space-between}

/* MAÃ‡ KARTI */
.match-card{background:var(--card);padding:12px;margin-bottom:10px;border-radius:12px;display:flex;flex-direction:column;gap:8px;border:1px solid var(--border);position:relative;overflow:hidden}
.item-display-area{display:flex; flex-wrap:wrap; gap:4px; background:rgba(0,0,0,0.15); padding:6px; border-radius:8px}
.item-mini-img{width:30px; height:30px; background:var(--panel); padding:3px; border-radius:5px}
.value-tag{color:var(--gold); font-weight:bold; font-size:12px}

/* OYUN EKRANI (OVERLAY) */
.game-overlay{position:absolute; inset:0; background:rgba(0,0,0,0.95); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:100; text-align:center}
.dice{font-size:50px; margin:10px; animation:shake 0.2s infinite; display:none}
@keyframes shake { 0%{transform:translate(2px,2px)} 50%{transform:translate(-2px,-2px)} 100%{transform:translate(2px,-2px)} }

#chat-msgs{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:6px}
.msg{background:var(--card);padding:8px;border-radius:8px;font-size:13px}
.msg b{color:var(--green);font-size:11px;display:block}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;display:none;align-items:center;justify-content:center}
.box{background:var(--panel);padding:25px;border-radius:15px;width:400px;text-align:center;border:1px solid var(--border)}
.grid{display:grid;grid-template-columns:repeat(5, 1fr);gap:8px;max-height:200px;overflow-y:auto;margin:15px 0}
.inv-card{background:var(--card);padding:5px;border-radius:8px;cursor:pointer;border:2px solid transparent}
.inv-card img{width:100%}
.inv-card.selected{border-color:var(--green)}

input{width:100%;padding:10px;background:var(--bg);border:1px solid var(--border);color:#fff;border-radius:8px;margin-bottom:10px}
.btn{background:var(--green);color:white;border:none;padding:12px;border-radius:8px;cursor:pointer;font-weight:bold;width:100%}
.btn-join{background:var(--gold); color:#000}
</style>
</head>
<body>

<div id="login-modal" class="modal-overlay">
    <div class="box">
        <h2>Roblox GiriÅŸ</h2>
        <input type="text" id="rbx-name" placeholder="KullanÄ±cÄ± AdÄ±...">
        <button class="btn" onclick="nextStep()">GiriÅŸ Yap</button>
        <div id="verify-section" style="display:none; margin-top:15px">
            <p>AÃ§Ä±klamaya ÅŸunu yaz:</p>
            <h3 id="v-code" style="color:var(--green)"></h3>
            <button class="btn" onclick="finishLogin()" style="margin-top:10px">Onayla</button>
        </div>
    </div>
</div>

<div id="inv-modal" class="modal-overlay">
    <div class="box">
        <h3>EÅŸya SeÃ§ (Max 15)</h3>
        <div class="grid" id="inventory-grid"></div>
        <button class="btn" onclick="createMatch()">MAÃ‡I BAÅžLAT</button>
        <button class="btn" onclick="closeInv()" style="margin-top:5px; background:#444">Ä°PTAL</button>
    </div>
</div>

<div class="main">
    <div class="header">
        <div style="font-weight:900; font-size:20px">BLOX<span style="color:var(--green)">LUCK</span></div>
        <div>ðŸ’° <span id="u-inv">0</span> | <span id="u-name">Misafir</span></div>
    </div>
    <div style="padding:20px; overflow-y: auto; flex:1">
        <button class="btn" style="width:200px" onclick="openInv()">+ MAÃ‡ OLUÅžTUR</button>
        <div id="match-list" style="margin-top:20px"></div>
    </div>
</div>

<div class="chat-area">
    <div id="chat-msgs"></div>
    <div style="padding:15px"><input type="text" id="chat-input" placeholder="Mesaj yaz..." onkeypress="if(event.key==='Enter') sendMsg()"></div>
</div>

<script>
// --- AYARLAR ---
let user = localStorage.getItem('rbx_user') || "";
let invCount = localStorage.getItem('rbx_inv') ? parseInt(localStorage.getItem('rbx_inv')) : 100;
const ITEM_IMG = "https://supremevalues.com/media/mm2ancients/Harvester.png";
const CH_GAME = "BLOX_DICE_MAIN";

// --- PUBNUB BAÄžLANTISI (SENÄ°N KODUN) ---
const pubnub = new PubNub({
    publishKey: "pub-c-497914f1-6785-4424-8902-613d94943f75", // Genelde sub ile beraber verilir
    subscribeKey: "sub-c-5f27998e-cff7-4c72-9ad1-455b7adeb737", // SENÄ°N VERDÄ°ÄžÄ°N KOD
    uuid: user || "u" + Math.random()
});

pubnub.subscribe({ channels: [CH_GAME] });

pubnub.addListener({
    message: (m) => {
        const d = m.message;
        if(d.type === 'chat') receiveChat(d.u, d.t);
        if(d.type === 'new') renderMatch(d.owner, d.id, d.amt);
        if(d.type === 'cancel') document.getElementById(d.id)?.remove();
        if(d.type === 'start') startDiceAnimation(d.id, d.owner, d.joiner);
    }
});

// --- OYUN MANTIÄžI ---
function renderMatch(owner, id, amt) {
    if(document.getElementById(id)) return;
    const list = document.getElementById('match-list');
    let imgs = ""; for(let i=0; i<amt; i++) imgs += `<img src="${ITEM_IMG}" class="item-mini-img">`;
    
    const div = document.createElement('div');
    div.className = "match-card"; div.id = id;
    div.innerHTML = `
        <div class="game-overlay" id="ov-${id}">
            <div class="dice" id="dice-${id}">ðŸŽ²</div>
            <div id="status-${id}" style="font-weight:bold">OYUNCU BEKLENÄ°YOR...</div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:5px">
            <b>${owner}</b>
            <span class="value-tag">Value: ${amt * 425}</span>
        </div>
        <div class="item-display-area">${imgs}</div>
        <div style="margin-top:10px">
            ${owner === user 
                ? `<button class="btn" style="background:var(--red)" onclick="cancelMatch('${id}')">Ä°PTAL ET</button>` 
                : `<button class="btn btn-join" onclick="joinMatch('${id}', ${amt})">KATIL (${amt})</button>`}
        </div>
    `;
    list.prepend(div);
}

function joinMatch(id, amt) {
    if(invCount < amt) return alert("Yeterli Harvester yok!");
    invCount -= amt; updateUI();
    pubnub.publish({ channel: CH_GAME, message: { type: 'start', id: id, owner: document.querySelector(`#${id} b`).innerText, joiner: user } });
}

function startDiceAnimation(id, owner, joiner) {
    const ov = document.getElementById('ov-'+id);
    const dice = document.getElementById('dice-'+id);
    const status = document.getElementById('status-'+id);
    if(!ov) return;

    ov.style.display = "flex";
    dice.style.display = "block";
    
    let timer = 3;
    const interval = setInterval(() => {
        status.innerText = "ZARLAR ATILIYOR: " + timer;
        timer--;
        if(timer < 0) {
            clearInterval(interval);
            dice.style.animation = "none";
            const winVal = Math.random();
            const winner = winVal > 0.5 ? owner : joiner;
            
            status.innerHTML = `<span style="color:var(--gold)">KAZANAN</span><br><h2 style="color:var(--green)">${winner}</h2>`;
            
            if(user === winner) {
                const total = document.querySelectorAll(`#${id} .item-mini-img`).length * 2;
                invCount += total;
                updateUI();
            }
            setTimeout(() => { document.getElementById(id).remove(); }, 4000);
        }
    }, 1000);
}

function createMatch() {
    if(selectedCount === 0) return;
    const mId = "M" + Math.floor(Math.random()*99999);
    pubnub.publish({ channel: CH_GAME, message: { type: 'new', owner: user, id: mId, amt: selectedCount } });
    invCount -= selectedCount;
    updateUI();
    closeInv();
}

function cancelMatch(id) {
    pubnub.publish({ channel: CH_GAME, message: { type: 'cancel', id: id } });
}

// --- CHAT VE UI ---
function sendMsg() {
    const i = document.getElementById('chat-input');
    if(!i.value) return;
    pubnub.publish({ channel: CH_GAME, message: { type: 'chat', u: user, t: i.value } });
    i.value = "";
}

function receiveChat(u, t) {
    const box = document.getElementById('chat-msgs');
    const div = document.createElement('div');
    div.className = "msg"; div.innerHTML = `<b>${u}</b> ${t}`;
    box.appendChild(div); box.scrollTop = box.scrollHeight;
}

function updateUI() {
    document.getElementById('u-inv').innerText = invCount;
    localStorage.setItem('rbx_inv', invCount);
}

let selectedCount = 0;
function openInv() {
    const grid = document.getElementById('inventory-grid');
    grid.innerHTML = ""; selectedCount = 0;
    for(let i=0; i<invCount; i++) {
        const d = document.createElement('div'); d.className = "inv-card";
        d.innerHTML = `<img src="${ITEM_IMG}">`;
        d.onclick = () => {
            if(d.classList.contains('selected')) { d.classList.remove('selected'); selectedCount--; }
            else if(selectedCount < 15) { d.classList.add('selected'); selectedCount++; }
        };
        grid.appendChild(d);
    }
    document.getElementById('inv-modal').style.display = "flex";
}

function closeInv() { document.getElementById('inv-modal').style.display = "none"; }
function nextStep() { document.getElementById('v-code').innerText = "LUCK-" + Math.floor(1000+Math.random()*9000); document.getElementById('verify-section').style.display = "block"; }
function finishLogin() { user = document.getElementById('rbx-name').value; localStorage.setItem('rbx_user', user); location.reload(); }

window.onload = () => {
    if(!user) document.getElementById('login-modal').style.display = "flex";
    else { document.getElementById('u-name').innerText = user; updateUI(); }
};
</script>
</body>
</html>
